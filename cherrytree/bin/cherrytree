#!/usr/bin/env python
import os
import sys

import click

from cherrytree.branch import CherryTreeBranch
from cherrytree.github_utils import check_if_branch_exists

sys.path.insert(0, os.path.abspath(".."))


@click.group()
def cli():
    click.secho("üçíüå≥üçí CherryTree", fg="cyan")


@cli.command()
@click.argument("minor_version")
@click.option(
    "--target-branch", "-t", help="target branch for baking. Leave empty for dry run"
)
@click.option(
    "--search-branch",
    "-s",
    multiple=True,
    help='Default "master", multiple is allowed as in "-s foo -s bar"',
)
@click.option(
    "--labels",
    "-l",
    multiple=True,
    help='PR labels to include in branch, default is "v{branch}"',
)
@click.option("--base-ref", "-r")
@click.option(
    "--dryrun/--no-dryrun",
    "-c",
    default=True,
    help="Should cherries be committed to target branch",
)
@click.option(
    "--error-mode",
    "-e",
    help="What to do in case of an error. `skip` skips conflicted cherries, "
         "`dryrun` reverts to dryrun for subsequent prs and `break` stops "
         "cherry picking.",
    type=click.Choice(["break", "dryrun", "skip"], case_sensitive=False),
    default="skip",
)
def bake(
    minor_version,
    target_branch,
    search_branch,
    base_ref,
    labels,
    dryrun,
    error_mode,
):
    """Applies cherries to release"""
    if dryrun:
        click.secho(
            "Running in dryrun mode, all changes will be rolled back", fg="cyan"
        )
    else:
        click.secho(
            "Running in non-dryrun mode, all changes will be committed!", fg="red"
        )
    if not dryrun and error_mode == "dryrun":
        click.secho(
            "In case of conflict: skip conflicted cherry, "
            "revert to dryrun mode for subsequent cherries", fg="cyan"
        )
    elif not dryrun and error_mode == "skip":
        click.secho(
            "In case of conflict: skip conflicted cherry, "
            "continue applying subsequent cherries", fg="cyan"
        )
    elif  not dryrun:
        click.secho(
            "In case of conflict: stop applying cherries, "
            "revert to dry-run for subsequent cherries", fg="cyan"
        )

    if target_branch and check_if_branch_exists(target_branch):
        minor_version = target_branch
    cherry_tree = CherryTreeBranch(
        minor_version,
        base_ref,
        labels=labels,
        search_branches=search_branch,
    )
    cherry_tree.apply_cherries(
        target_branch=target_branch,
        dryrun=dryrun,
        error_mode=error_mode,
    )


if __name__ == "__main__":
    cli()
